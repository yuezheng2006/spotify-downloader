# spotDL 技术架构

> 图解 spotDL 的核心架构与工作流程

---

## 📐 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户接口层                               │
├─────────────────────────────────────────────────────────────────┤
│  CLI 命令行    │    Web UI    │    Python API    │  Batch Tool │
│   spotdl       │   Web界面    │   导入使用       │  批量下载    │
└────────┬────────────────┬────────────────┬──────────────┬───────┘
         │                │                │              │
         └────────────────┴────────────────┴──────────────┘
                              │
         ┌────────────────────┴─────────────────────┐
         │          核心处理层                       │
         │  ┌─────────────────────────────────┐    │
         │  │      Downloader 下载器          │    │
         │  │  • 任务调度                      │    │
         │  │  • 并发控制                      │    │
         │  │  • 进度追踪                      │    │
         │  └─────────────────────────────────┘    │
         └────────────────────┬─────────────────────┘
                              │
         ┌────────────────────┴─────────────────────┐
         │          数据提供层                       │
         ├──────────────┬───────────┬──────────────┤
         │  Spotify API │ Audio源   │  Lyrics源     │
         │  • 元数据    │ • YouTube │  • Genius     │
         │  • 专辑信息  │ • YT Music│  • MusixMatch │
         │  • 搜索      │ • 备用源  │  • Synced     │
         └──────────────┴───────────┴──────────────┘
                              │
         ┌────────────────────┴─────────────────────┐
         │          输出处理层                       │
         │  FFmpeg 转码 │ Mutagen 元数据 │ 文件系统 │
         └──────────────────────────────────────────┘
```

---

## 🔄 核心工作流

```
用户输入 Spotify URL
        ↓
┌───────────────────────┐
│  1. URL解析           │
│  • 识别类型           │
│  • track/album/       │
│    playlist/artist    │
└───────┬───────────────┘
        ↓
┌───────────────────────┐
│  2. Spotify API       │
│  • 获取元数据         │
│  • 解析曲目列表       │
│  • 提取封面URL        │
└───────┬───────────────┘
        ↓
┌───────────────────────┐
│  3. 搜索匹配          │
│  • 构造搜索词         │
│  • YouTube搜索        │
│  • 智能匹配算法       │
└───────┬───────────────┘
        ↓
┌───────────────────────┐
│  4. 音频下载          │
│  • yt-dlp下载         │
│  • 选择最高比特率     │
│  • 临时文件存储       │
└───────┬───────────────┘
        ↓
┌───────────────────────┐
│  5. 格式转换          │
│  • FFmpeg转码         │
│  • 音频后处理         │
│  • 比特率优化         │
└───────┬───────────────┘
        ↓
┌───────────────────────┐
│  6. 元数据嵌入        │
│  • ID3标签写入        │
│  • 专辑封面嵌入       │
│  • 歌词嵌入           │
└───────┬───────────────┘
        ↓
┌───────────────────────┐
│  7. 歌词获取          │
│  • 多源尝试           │
│  • LRC格式生成        │
│  • 同步歌词处理       │
└───────┬───────────────┘
        ↓
    最终文件输出
```

---

## 🏗️ 模块架构

### 核心模块

```
spotdl/
├─── console/          命令行接口
│    ├─ download.py    下载命令
│    ├─ sync.py        同步命令
│    ├─ web.py         Web命令
│    └─ entry_point.py 入口
│
├─── download/         下载引擎
│    ├─ downloader.py  ┌─────────────────────┐
│    │                 │ Downloader类        │
│    │                 │ • search()          │
│    │                 │ • download_song()   │
│    │                 │ • download_multiple()│
│    │                 └─────────────────────┘
│    │
│    └─ progress.py    进度条显示
│
├─── providers/        内容提供商
│    ├─ audio/         ┌─────────────────────┐
│    │  ├─ youtube.py │ YouTube Provider    │
│    │  ├─ ytmusic.py │ • 搜索API           │
│    │  └─ base.py    │ • 下载逻辑          │
│    │                 │ • 质量选择          │
│    │                 └─────────────────────┘
│    │
│    └─ lyrics/        ┌─────────────────────┐
│       ├─ genius.py   │ Lyrics Providers    │
│       ├─ musixmatch/ │ • 网页爬取          │
│       └─ synced.py   │ • API调用           │
│                      │ • 同步歌词          │
│                      └─────────────────────┘
│
├─── types/            数据模型
│    ├─ song.py        ┌─────────────────────┐
│    ├─ album.py       │ Pydantic Models     │
│    ├─ playlist.py    │ • 类型验证          │
│    └─ artist.py      │ • JSON序列化        │
│                      └─────────────────────┘
│
└─── utils/            工具函数
     ├─ spotify.py     Spotify客户端
     ├─ search.py      搜索匹配算法
     ├─ ffmpeg.py      FFmpeg封装
     ├─ metadata.py    元数据处理
     └─ matching.py    智能匹配
```

---

## 🎯 关键流程详解

### 1. Spotify元数据获取

```
┌──────────────────────────────────────────────────────┐
│                  SpotifyClient                       │
│  ┌────────────────────────────────────────────┐     │
│  │  spotipy (Python Library)                  │     │
│  │  └─ OAuth 2.0 认证                         │     │
│  └────────────────────────────────────────────┘     │
│                      ↓                               │
│  ┌────────────────────────────────────────────┐     │
│  │  获取歌曲信息                               │     │
│  │  • track.get(track_id)                     │     │
│  │  • album.get(album_id)                     │     │
│  │  • playlist.get(playlist_id)               │     │
│  └────────────────────────────────────────────┘     │
│                      ↓                               │
│  ┌────────────────────────────────────────────┐     │
│  │  解析返回JSON数据                          │     │
│  │  {                                         │     │
│  │    "name": "晴天",                         │     │
│  │    "artists": [                            │     │
│  │      {"name": "周杰伦", "id": "..."}       │     │
│  │    ],                                      │     │
│  │    "album": {                              │     │
│  │      "name": "叶惠美",                      │     │
│  │      "images": [{"url": "..."}]            │     │
│  │    },                                      │     │
│  │    "duration_ms": 269000,                  │     │
│  │    "isrc": "TWK970300503",                 │     │
│  │    "external_urls": {                      │     │
│  │      "spotify": "https://..."              │     │
│  │    }                                       │     │
│  │  }                                         │     │
│  └────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────┘
```

### 2. YouTube搜索匹配

```
┌─────────────────────────────────────────────────────┐
│              搜索词构造                              │
│  "周杰伦 晴天 official audio"                        │
└────────────────┬────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────────┐
│           YouTube Music API 搜索                     │
│  ┌───────────────────────────────────────────┐     │
│  │  返回结果列表:                             │     │
│  │  [                                        │     │
│  │    {title, artist, duration, videoId},    │     │
│  │    {title, artist, duration, videoId},    │     │
│  │    ...                                    │     │
│  │  ]                                        │     │
│  └───────────────────────────────────────────┘     │
└────────────────┬────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────────┐
│              智能匹配算法                            │
│  ┌───────────────────────────────────────────┐     │
│  │  匹配分数计算:                             │     │
│  │  • 标题相似度 (Levenshtein Distance)      │     │
│  │  • 艺术家匹配                              │     │
│  │  • 时长差异 (±5秒容差)                     │     │
│  │  • ISRC码匹配 (如有)                       │     │
│  └───────────────────────────────────────────┘     │
│                      ↓                              │
│  选择最佳匹配 (score > 85%)                         │
└─────────────────────────────────────────────────────┘
```

### 3. 音频下载与处理

```
┌─────────────────────────────────────────────────────┐
│                 yt-dlp 下载器                        │
│  ┌───────────────────────────────────────────┐     │
│  │  youtube.com/watch?v=xxxxx                │     │
│  │  → 解析视频信息                            │     │
│  │  → 选择音频流 (bestaudio)                  │     │
│  │  → 下载到临时文件                          │     │
│  └───────────────────────────────────────────┘     │
└────────────────┬────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────────┐
│                 FFmpeg 处理                          │
│  ┌───────────────────────────────────────────┐     │
│  │  ffmpeg -i input.webm \                   │     │
│  │         -c:a libmp3lame \                 │     │
│  │         -b:a 256k \                       │     │
│  │         -ar 48000 \                       │     │
│  │         output.mp3                        │     │
│  └───────────────────────────────────────────┘     │
│                      ↓                              │
│  • 音频编码转换                                      │
│  • 比特率调整                                        │
│  • 采样率设置                                        │
│  • 声道配置                                          │
└─────────────────────────────────────────────────────┘
```

### 4. 元数据嵌入

```
┌─────────────────────────────────────────────────────┐
│               Mutagen (ID3标签)                      │
│  ┌───────────────────────────────────────────┐     │
│  │  MP3 文件                                  │     │
│  │  ├─ TIT2  标题                             │     │
│  │  ├─ TPE1  艺术家                           │     │
│  │  ├─ TALB  专辑                             │     │
│  │  ├─ TDRC  年份                             │     │
│  │  ├─ TRCK  音轨号                           │     │
│  │  ├─ TCON  流派                             │     │
│  │  ├─ USLT  歌词                             │     │
│  │  ├─ APIC  封面图片                         │     │
│  │  └─ COMM  备注                             │     │
│  └───────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────┐
│              专辑封面处理                            │
│  Spotify封面URL → requests下载 → PIL调整           │
│  → 转换为JPEG → 嵌入到APIC标签                      │
└─────────────────────────────────────────────────────┘
```

---

## 🔌 数据流图

```
                  ┌───────────┐
                  │  用户输入  │
                  └─────┬─────┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
   ┌────▼────┐    ┌────▼────┐    ┌────▼────┐
   │ 单曲URL │    │ 专辑URL │    │ 列表URL │
   └────┬────┘    └────┬────┘    └────┬────┘
        │               │               │
        └───────────────┼───────────────┘
                        │
                   ┌────▼────┐
                   │ Spotify │
                   │   API   │
                   └────┬────┘
                        │
              ┌─────────┴─────────┐
              │   元数据解析       │
              │   Song对象列表     │
              └─────────┬─────────┘
                        │
                        ├─────────┐
                        │         │
                   ┌────▼────┐    │
                   │  搜索    │    │
                   │ YouTube  │    │
                   └────┬────┘    │
                        │         │
                   ┌────▼────┐    │
                   │  下载    │    │
                   │  音频    │    │
                   └────┬────┘    │
                        │         │
                   ┌────▼────┐    │
                   │ FFmpeg  │    │
                   │  转码    │    │
                   └────┬────┘    │
                        │         │
                   ┌────▼────┐    │
              ┌────┤ 元数据  │    │
              │    │  嵌入    │    │
              │    └────┬────┘    │
              │         │         │
        ┌─────▼─────┐   │   ┌─────▼─────┐
        │  下载封面  │   │   │  获取歌词  │
        └─────┬─────┘   │   └─────┬─────┘
              │         │         │
              └─────────┴─────────┘
                        │
                   ┌────▼────┐
                   │ 最终文件 │
                   │ ├─ .mp3 │
                   │ ├─ .lrc │
                   │ └─ cover│
                   └─────────┘
```

---

## 🧩 关键技术栈

```
┌──────────────────────────────────────────────────────┐
│                   核心依赖                            │
├──────────────────────────────────────────────────────┤
│  spotipy          │  Spotify API客户端               │
│  yt-dlp           │  YouTube下载器                   │
│  ytmusicapi       │  YouTube Music API               │
│  mutagen          │  音频元数据处理                  │
│  ffmpeg-python    │  FFmpeg Python封装               │
│  requests         │  HTTP请求                        │
│  beautifulsoup4   │  HTML解析（歌词爬取）            │
│  rapidfuzz        │  字符串模糊匹配                  │
│  pydantic         │  数据验证                        │
│  rich             │  终端UI美化                      │
│  syncedlyrics     │  同步歌词库                      │
└──────────────────────────────────────────────────────┘
```

---

## 📦 增强工具架构

### download_batch.py

```
┌─────────────────────────────────────────────────────┐
│           SpotifyBatchDownloader                    │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌──────────────────────────────────────┐         │
│  │  URL类型检测                          │         │
│  │  • track  → 单曲                      │         │
│  │  • album  → 专辑                      │         │
│  │  • playlist → 播放列表                │         │
│  │  • artist → 艺术家                    │         │
│  └──────────────┬───────────────────────┘         │
│                 │                                  │
│  ┌──────────────▼───────────────────────┐         │
│  │  批量处理循环                         │         │
│  │  for song in songs:                  │         │
│  │    • 检查是否已存在                   │         │
│  │    • spotdl下载                       │         │
│  │    • 移动到独立目录                   │         │
│  │    • 提取元数据                       │         │
│  │    • 生成报告文件                     │         │
│  └──────────────┬───────────────────────┘         │
│                 │                                  │
│  ┌──────────────▼───────────────────────┐         │
│  │  输出结构                             │         │
│  │  Artist - Song/                      │         │
│  │  ├─ song.mp3                         │         │
│  │  ├─ song.lrc                         │         │
│  │  ├─ cover.jpg                        │         │
│  │  ├─ metadata.txt                     │         │
│  │  └─ metadata.json                    │         │
│  └──────────────────────────────────────┘         │
└─────────────────────────────────────────────────────┘
```

---

## 🔐 安全与性能

### 并发控制

```
┌────────────────────────────────────────┐
│      ThreadPoolExecutor               │
│  ┌──────────────────────────────┐    │
│  │  max_workers = CPU核心数      │    │
│  │  • 并行下载多首歌             │    │
│  │  • 避免API限流                │    │
│  │  • 进度条同步更新             │    │
│  └──────────────────────────────┘    │
└────────────────────────────────────────┘
```

### 缓存机制

```
.spotdl-cache/
├─ spotify_cache.json    Spotify API响应缓存
├─ youtube_cache.json    YouTube搜索缓存
└─ lyrics_cache.json     歌词缓存
```

### 错误处理

```
try-except 层次:
  ├─ 网络错误重试 (3次)
  ├─ API限流等待
  ├─ 文件冲突跳过
  └─ 日志记录详情
```

---

## 📊 性能指标

| 操作 | 平均耗时 | 说明 |
|------|---------|------|
| Spotify元数据 | 0.5-1s | API调用 |
| YouTube搜索 | 1-2s | 网络延迟 |
| 音频下载 | 10-30s | 取决于网速和歌曲长度 |
| FFmpeg转码 | 2-5s | CPU密集型 |
| 元数据嵌入 | <1s | 磁盘IO |
| 总计（单曲） | 15-40s | 完整流程 |

---

## 🎨 设计模式

```
• Singleton   → SpotifyClient (全局唯一)
• Factory     → AudioProvider选择
• Strategy    → LyricsProvider切换
• Observer    → 进度回调
• Chain       → 歌词多源尝试
```

---

## 🔮 扩展性

```
新增音频源:
  providers/audio/newsource.py
  └─ 继承 BaseProvider
  └─ 实现 search() & download()

新增歌词源:
  providers/lyrics/newsource.py
  └─ 继承 BaseLyricsProvider
  └─ 实现 get_lyrics()
```

---

## 📝 总结

spotDL通过**模块化设计**实现了：

- ✅ **解耦架构** - 各层独立可替换
- ✅ **多源支持** - 音频/歌词多提供商
- ✅ **高可靠性** - 完善的错误处理
- ✅ **高性能** - 并发下载与缓存
- ✅ **易扩展** - 清晰的接口设计

核心思想：**公开资源组合 + 智能匹配 = 完美音乐库**

